<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incubatee Management - ATBI Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/incubate.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/agrilogo.png') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <div class="header">
        <h1>üè¢ Incubatee Management</h1>
        <div class="header-actions">
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn-back">‚Üê Back to Dashboard</a>
            <a href="{{ url_for('admin.admin_profile') }}" class="profile-btn">
                <span class="icon">üë§</span> Profile
            </a>
            <button class="logout-btn" onclick="logout()">üö™ Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Incubatees List</h2>
                <div class="card-actions">
                    <button class="btn-refresh" onclick="loadIncubatees()">üîÑ Refresh</button>
                    <button class="btn-add" onclick="openAddIncubateeModal()">‚ûï Add Incubatee</button>
                    <div class="search-box">
                        <input type="text" id="incubateeSearch" placeholder="Search incubatees..." onkeyup="filterIncubatees()">
                        <span class="search-icon">üîç</span>
                    </div>
                    <div class="filter-tabs">
                        <button class="filter-tab active" onclick="setIncubateeFilter('all')">All</button>
                        <button class="filter-tab" onclick="setIncubateeFilter('approved')">Approved</button>
                        <button class="filter-tab" onclick="setIncubateeFilter('pending')">Pending</button>
                    </div>
                </div>
            </div>

            <div class="stats-summary">
                <div class="stat-card">
                    <div class="stat-value" id="totalIncubatees">0</div>
                    <div class="stat-label">Total Incubatees</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value approved" id="approvedIncubatees">0</div>
                    <div class="stat-label">Approved</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value pending" id="pendingIncubatees">0</div>
                    <div class="stat-label">Pending Approval</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalProducts">0</div>
                    <div class="stat-label">Total Products</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value revenue">‚Ç±0.00</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
            </div>

            <div class="incubatees-container" id="incubatees-container">
                <div class="loading-state">Loading incubatees...</div>
            </div>
        </div>

        <!-- Add Incubatee Modal -->
        <div id="addIncubateeModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add New Incubatee</h2>
                    <button class="close-btn" onclick="closeAddIncubateeModal()">&times;</button>
                </div>
                <form id="addIncubateeForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="add_first_name" name="first_name" required>
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="add_last_name" name="last_name" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Middle Name</label>
                        <input type="text" id="add_middle_name" name="middle_name">
                    </div>
                    <div class="form-group">
                        <label>Company Name</label>
                        <input type="text" id="add_company_name" name="company_name">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" id="add_email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="text" id="add_phone_number" name="phone_number">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Contact Info</label>
                        <textarea id="add_contact_info" name="contact_info" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Batch</label>
                        <input type="number" id="add_batch" name="batch">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="add_is_approved" name="is_approved" checked>
                            Approve immediately
                        </label>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeAddIncubateeModal()">Cancel</button>
                        <button type="submit" class="btn-save">Add Incubatee</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Incubatee Details Modal -->
        <div id="incubateeDetailsModal" class="modal">
            <div class="modal-content large-modal">
                <div class="modal-header">
                    <h2>Incubatee Details</h2>
                    <button class="close-btn" onclick="closeIncubateeModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="incubateeDetailsContent">
                        <!-- Incubatee details will be loaded here -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeIncubateeModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
    <script>
        let allIncubatees = [];
        let currentFilter = 'all';

        // Load incubatees when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadIncubatees();
        });

        async function loadIncubatees() {
            try {
                const response = await fetch('/admin/get-incubatees-list');
                const data = await response.json();
                
                if (data.success) {
                    allIncubatees = data.incubatees;
                    filterAndDisplayIncubatees();
                    updateIncubateeStats(allIncubatees);
                } else {
                    showNotification('Error loading incubatees: ' + data.error, 'error');
                    document.getElementById('incubatees-container').innerHTML = 
                        '<div class="error-state">Failed to load incubatees. Please try again.</div>';
                }
            } catch (error) {
                console.error('Error fetching incubatees:', error);
                showNotification('Failed to load incubatees', 'error');
                document.getElementById('incubatees-container').innerHTML = 
                    '<div class="error-state">Network error. Please check your connection.</div>';
            }
        }

        function filterAndDisplayIncubatees() {
            let filteredIncubatees = allIncubatees;
            
            // Apply status filter
            if (currentFilter === 'approved') {
                filteredIncubatees = filteredIncubatees.filter(i => i.is_approved);
            } else if (currentFilter === 'pending') {
                filteredIncubatees = filteredIncubatees.filter(i => !i.is_approved);
            }
            
            // Apply search filter
            const searchTerm = document.getElementById('incubateeSearch').value.toLowerCase();
            if (searchTerm) {
                filteredIncubatees = filteredIncubatees.filter(i => 
                    i.full_name.toLowerCase().includes(searchTerm) ||
                    (i.company_name && i.company_name.toLowerCase().includes(searchTerm)) ||
                    (i.email && i.email.toLowerCase().includes(searchTerm))
                );
            }
            
            displayIncubatees(filteredIncubatees);
        }

        function displayIncubatees(incubatees) {
            const container = document.getElementById('incubatees-container');
            
            if (incubatees.length === 0) {
                container.innerHTML = '<div class="no-data">No incubatees found.</div>';
                return;
            }

            container.innerHTML = incubatees.map(incubatee => `
                <div class="incubatee-card ${incubatee.is_approved ? 'approved' : 'pending'}">
                    <div class="incubatee-header">
                        <div class="incubatee-avatar">
                            ${incubatee.full_name.charAt(0).toUpperCase()}
                        </div>
                        <div class="incubatee-basic-info">
                            <h3>${escapeHtml(incubatee.full_name)}</h3>
                            <p class="company-name">${escapeHtml(incubatee.company_name || 'No Company')}</p>
                            <p class="incubatee-id">ID: ${incubatee.incubatee_id} ‚Ä¢ Batch: ${incubatee.batch || 'N/A'}</p>
                        </div>
                        <div class="incubatee-actions">
                            <button class="btn-toggle-approval ${incubatee.is_approved ? 'btn-approved' : 'btn-pending'}" 
                                    onclick="toggleIncubateeApproval(${incubatee.incubatee_id})">
                                ${incubatee.is_approved ? '‚úÖ Approved' : '‚è≥ Pending'}
                            </button>
                            <button class="btn-view" onclick="showIncubateeDetails(${incubatee.incubatee_id})">
                                üëÅÔ∏è View
                            </button>
                        </div>
                    </div>
                    
                    <div class="incubatee-contact">
                        <div class="contact-item">
                            <span class="contact-icon">üìß</span>
                            <span>${escapeHtml(incubatee.email || 'No email')}</span>
                        </div>
                        <div class="contact-item">
                            <span class="contact-icon">üìû</span>
                            <span>${escapeHtml(incubatee.phone || 'No phone')}</span>
                        </div>
                    </div>
                    
                    <div class="incubatee-stats">
                        <div class="stat">
                            <span class="stat-value">${incubatee.product_count}</span>
                            <span class="stat-label">Products</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value revenue">‚Ç±${incubatee.total_sales.toFixed(2)}</span>
                            <span class="stat-label">Total Sales</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value">${formatDateOnly(incubatee.created_at)}</span>
                            <span class="stat-label">Joined</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateIncubateeStats(incubatees) {
            const totalIncubatees = incubatees.length;
            const approvedIncubatees = incubatees.filter(i => i.is_approved).length;
            const pendingIncubatees = incubatees.filter(i => !i.is_approved).length;
            const totalProducts = incubatees.reduce((sum, i) => sum + i.product_count, 0);
            const totalRevenue = incubatees.reduce((sum, i) => sum + i.total_sales, 0);

            document.getElementById('totalIncubatees').textContent = totalIncubatees;
            document.getElementById('approvedIncubatees').textContent = approvedIncubatees;
            document.getElementById('pendingIncubatees').textContent = pendingIncubatees;
            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('totalRevenue').textContent = '‚Ç±' + totalRevenue.toFixed(2);
        }

        function setIncubateeFilter(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            filterAndDisplayIncubatees();
        }

        function filterIncubatees() {
            filterAndDisplayIncubatees();
        }

        async function toggleIncubateeApproval(incubateeId) {
            if (!confirm('Are you sure you want to change the approval status?')) return;
            
            try {
                const response = await fetch(`/admin/toggle-incubatee-approval/${incubateeId}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(data.message, 'success');
                    loadIncubatees(); // Refresh the list
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error toggling approval:', error);
                showNotification('Failed to update approval status', 'error');
            }
        }

        function openAddIncubateeModal() {
            document.getElementById('addIncubateeModal').classList.add('active');
        }

        function closeAddIncubateeModal() {
            document.getElementById('addIncubateeModal').classList.remove('active');
            document.getElementById('addIncubateeForm').reset();
        }

        async function showIncubateeDetails(incubateeId) {
            try {
                const incubatee = allIncubatees.find(i => i.incubatee_id === incubateeId);
                if (!incubatee) return;

                const modal = document.getElementById('incubateeDetailsModal');
                const content = document.getElementById('incubateeDetailsContent');

                // Load incubatee products
                const productsResponse = await fetch(`/admin/get-incubatee-products/${incubateeId}`);
                const productsData = await productsResponse.json();
                const products = productsData.success ? productsData.products : [];

                content.innerHTML = `
                    <div class="incubatee-detail-section">
                        <h3>Basic Information</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>Incubatee ID:</label>
                                <span>${incubatee.incubatee_id}</span>
                            </div>
                            <div class="detail-item">
                                <label>Full Name:</label>
                                <span>${escapeHtml(incubatee.full_name)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Company:</label>
                                <span>${escapeHtml(incubatee.company_name || 'N/A')}</span>
                            </div>
                            <div class="detail-item">
                                <label>Batch:</label>
                                <span>${incubatee.batch || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <label>Email:</label>
                                <span>${escapeHtml(incubatee.email || 'N/A')}</span>
                            </div>
                            <div class="detail-item">
                                <label>Phone:</label>
                                <span>${escapeHtml(incubatee.phone || 'N/A')}</span>
                            </div>
                            <div class="detail-item">
                                <label>Status:</label>
                                <span class="status-badge ${incubatee.is_approved ? 'status-approved' : 'status-pending'}">
                                    ${incubatee.is_approved ? 'Approved' : 'Pending Approval'}
                                </span>
                            </div>
                            <div class="detail-item">
                                <label>Join Date:</label>
                                <span>${formatDateToReadable(incubatee.created_at)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="incubatee-detail-section">
                        <h3>Business Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-card mini">
                                <div class="stat-value">${incubatee.product_count}</div>
                                <div class="stat-label">Total Products</div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-value revenue">‚Ç±${incubatee.total_sales.toFixed(2)}</div>
                                <div class="stat-label">Total Revenue</div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-value">${products.filter(p => p.stock_amount > 0).length}</div>
                                <div class="stat-label">In Stock</div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-value">${products.filter(p => p.stock_amount === 0).length}</div>
                                <div class="stat-label">Out of Stock</div>
                            </div>
                        </div>
                    </div>

                    <div class="incubatee-detail-section">
                        <h3>Products (${products.length})</h3>
                        ${products.length === 0 ? 
                            '<p class="no-data">No products added yet.</p>' :
                            `<div class="products-list">
                                ${products.map(product => `
                                    <div class="product-item">
                                        <div class="product-image">
                                            ${product.image_path ? 
                                                `<img src="/${product.image_path}" alt="${escapeHtml(product.name)}">` :
                                                '<div class="no-image">üì∑</div>'
                                            }
                                        </div>
                                        <div class="product-info">
                                            <h4>${escapeHtml(product.name)}</h4>
                                            <p class="product-category">${product.category || 'Uncategorized'}</p>
                                            <p class="product-stock">Stock: ${product.stock_amount} ‚Ä¢ Price: ‚Ç±${product.price_per_stocks.toFixed(2)}</p>
                                        </div>
                                        <div class="product-status ${product.stock_amount > 0 ? 'in-stock' : 'out-of-stock'}">
                                            ${product.stock_amount > 0 ? 'In Stock' : 'Out of Stock'}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>`
                        }
                    </div>
                `;

                modal.classList.add('active');
            } catch (error) {
                console.error('Error showing incubatee details:', error);
                showNotification('Failed to load incubatee details', 'error');
            }
        }

        function closeIncubateeModal() {
            document.getElementById('incubateeDetailsModal').classList.remove('active');
        }

        // Handle add incubatee form submission
        document.getElementById('addIncubateeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                first_name: document.getElementById('add_first_name').value,
                last_name: document.getElementById('add_last_name').value,
                middle_name: document.getElementById('add_middle_name').value,
                company_name: document.getElementById('add_company_name').value,
                email: document.getElementById('add_email').value,
                phone_number: document.getElementById('add_phone_number').value,
                contact_info: document.getElementById('add_contact_info').value,
                batch: document.getElementById('add_batch').value,
                is_approved: document.getElementById('add_is_approved').checked
            };

            try {
                const response = await fetch('/admin/add-incubatee', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('‚úÖ Incubatee added successfully!', 'success');
                    closeAddIncubateeModal();
                    loadIncubatees(); // Refresh the list
                } else {
                    showNotification('‚ùå Error: ' + data.error, 'error');
                }
            } catch (error) {
                console.error('Error adding incubatee:', error);
                showNotification('‚ùå Failed to add incubatee', 'error');
            }
        });

        // Close modals when clicking outside
        document.getElementById('addIncubateeModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAddIncubateeModal();
            }
        });

        document.getElementById('incubateeDetailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeIncubateeModal();
            }
        });
    </script>
</body>
</html>