<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - ATBI Admin</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/users.css') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/agrilogo.png') }}">
</head>
<body>
    <div class="header">
        <h1>üë• User Management</h1>
        <div class="header-actions">
            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn-back">‚Üê Back to Dashboard</a>
            <a href="{{ url_for('admin.admin_profile') }}" class="profile-btn">
                <span class="icon">üë§</span> Profile
            </a>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>Registered Users</h2>
                <div class="card-actions">
                    <button class="btn-refresh" onclick="loadUsers()">üîÑ Refresh</button>
                    <div class="search-box">
                        <input type="text" id="userSearch" placeholder="Search users..." onkeyup="filterUsers()">
                        <span class="search-icon">üîç</span>
                    </div>
                </div>
            </div>

            <div class="stats-summary">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeUsers">0</div>
                    <div class="stat-label">Active Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalReservations">0</div>
                    <div class="stat-label">Total Reservations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completionRate">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
            </div>

            <div class="users-container" id="users-container">
                <div class="loading-state">Loading users...</div>
            </div>
        </div>

        <!-- User Details Modal -->
        <div id="userDetailsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>User Details</h2>
                    <button class="close-btn" onclick="closeUserModal()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="userDetailsContent">
                        <!-- User details will be loaded here -->
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeUserModal()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
    <script>
        let allUsers = [];

        // Load users when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });

        async function loadUsers() {
            try {
                const response = await fetch('/admin/get-users');
                const data = await response.json();
                
                if (data.success) {
                    allUsers = data.users;
                    displayUsers(allUsers);
                    updateUserStats(allUsers);
                } else {
                    showNotification('Error loading users: ' + data.error, 'error');
                    document.getElementById('users-container').innerHTML = 
                        '<div class="error-state">Failed to load users. Please try again.</div>';
                }
            } catch (error) {
                console.error('Error fetching users:', error);
                showNotification('Failed to load users', 'error');
                document.getElementById('users-container').innerHTML = 
                    '<div class="error-state">Network error. Please check your connection.</div>';
            }
        }

        function displayUsers(users) {
            const container = document.getElementById('users-container');
            
            if (users.length === 0) {
                container.innerHTML = '<div class="no-data">No users found.</div>';
                return;
            }

            container.innerHTML = users.map(user => `
                <div class="user-card" onclick="showUserDetails(${user.user_id})">
                    <div class="user-header">
                        <div class="user-avatar">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div class="user-basic-info">
                            <h3>${escapeHtml(user.username)}</h3>
                            <p class="user-id">ID: ${user.user_id}</p>
                            <p class="join-date">Joined: ${formatDateToReadable(user.created_at)}</p>
                        </div>
                        <div class="user-status">
                            <span class="status-badge ${user.total_reservations > 0 ? 'status-active' : 'status-inactive'}">
                                ${user.total_reservations > 0 ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    </div>
                    
                    <div class="user-stats">
                        <div class="stat">
                            <span class="stat-value">${user.total_reservations}</span>
                            <span class="stat-label">Total Orders</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value pending">${user.pending_reservations}</span>
                            <span class="stat-label">Pending</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value approved">${user.approved_reservations}</span>
                            <span class="stat-label">Approved</span>
                        </div>
                        <div class="stat">
                            <span class="stat-value completed">${user.completed_reservations}</span>
                            <span class="stat-label">Completed</span>
                        </div>
                    </div>
                    
                    <div class="user-actions">
                        <button class="btn-view" onclick="event.stopPropagation(); showUserDetails(${user.user_id})">
                            üëÅÔ∏è View Details
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateUserStats(users) {
            const totalUsers = users.length;
            const activeUsers = users.filter(user => user.total_reservations > 0).length;
            const totalReservations = users.reduce((sum, user) => sum + user.total_reservations, 0);
            const completedReservations = users.reduce((sum, user) => sum + user.completed_reservations, 0);
            const completionRate = totalReservations > 0 ? ((completedReservations / totalReservations) * 100).toFixed(1) : 0;

            document.getElementById('totalUsers').textContent = totalUsers;
            document.getElementById('activeUsers').textContent = activeUsers;
            document.getElementById('totalReservations').textContent = totalReservations;
            document.getElementById('completionRate').textContent = completionRate + '%';
        }

        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm) ||
                user.user_id.toString().includes(searchTerm)
            );
            displayUsers(filteredUsers);
        }

        async function showUserDetails(userId) {
            try {
                const user = allUsers.find(u => u.user_id === userId);
                if (!user) return;

                const modal = document.getElementById('userDetailsModal');
                const content = document.getElementById('userDetailsContent');

                content.innerHTML = `
                    <div class="user-detail-section">
                        <h3>Basic Information</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <label>User ID:</label>
                                <span>${user.user_id}</span>
                            </div>
                            <div class="detail-item">
                                <label>Username:</label>
                                <span>${escapeHtml(user.username)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Join Date:</label>
                                <span>${formatDateToReadable(user.created_at)}</span>
                            </div>
                            <div class="detail-item">
                                <label>Status:</label>
                                <span class="status-badge ${user.total_reservations > 0 ? 'status-active' : 'status-inactive'}">
                                    ${user.total_reservations > 0 ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <h3>Reservation Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-card mini">
                                <div class="stat-value">${user.total_reservations}</div>
                                <div class="stat-label">Total Reservations</div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-value pending">${user.pending_reservations}</div>
                                <div class="stat-label">Pending</div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-value approved">${user.approved_reservations}</div>
                                <div class="stat-label">Approved</div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-value completed">${user.completed_reservations}</div>
                                <div class="stat-label">Completed</div>
                            </div>
                        </div>
                    </div>

                    <div class="user-detail-section">
                        <h3>Recent Activity</h3>
                        <div class="activity-list">
                            ${user.total_reservations === 0 ? 
                                '<p class="no-activity">No recent activity</p>' :
                                `<p>User has made ${user.total_reservations} reservations in total.</p>
                                 <p>Completion rate: ${user.total_reservations > 0 ? ((user.completed_reservations / user.total_reservations) * 100).toFixed(1) : 0}%</p>`
                            }
                        </div>
                    </div>
                `;

                modal.classList.add('active');
            } catch (error) {
                console.error('Error showing user details:', error);
                showNotification('Failed to load user details', 'error');
            }
        }

        function closeUserModal() {
            document.getElementById('userDetailsModal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('userDetailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeUserModal();
            }
        });
    </script>
</body>
</html>