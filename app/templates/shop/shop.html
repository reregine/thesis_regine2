<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Character encoding for proper text display -->
    <meta charset="UTF-8">
    <!-- Responsive viewport for mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Page title that appears in browser tab -->
    <title>Shop - ATBI Agri-Aqua Products</title>
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/agrilogo.png') }}">
    <!-- Link to external CSS file for styling -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shop.css') }}">
</head>
<body>
    <!-- Header Section - Fixed navigation bar at the top -->
    <header class="header">
        <!-- Container to center and limit the width of header content -->
        <div class="header-container">
            <!-- Logo section on the left side -->
            <div class="logo">
                <!-- Company logo image - replace logo.png with your actual logo file -->
                <img src="{{ url_for('static', filename='images/agrilogo.png') }}" alt="Store Logo" class="logo-img">
            </div>
            <!-- Navigation menu on the right side -->
            <nav class="nav-menu">
                <!-- Unordered list containing navigation links -->
                <ul class="nav-list">
                    <!-- Each list item contains a navigation link -->
                    <li><a href="{{ url_for('home.index') }}" class="nav-link">HOME</a></li>
                    <li><a href="{{ url_for('shop.shop_home') }}" class="nav-link">SHOP</a></li>
                    <li><a href="{{ url_for('incubatee_showroom.incubatee_showroom') }}" class="nav-link">INCUBATES</a></li>
                    <li><a href="{{ url_for('home.index') }}#about" class="nav-link">ABOUT</a></li>
                    <li><a href="{{ url_for('contact.contact_page')}}" class="nav-link">CONTACTS</a></li>
                    <!-- Cart button with special styling -->
                    <li><a href="#" id="openCartBtn" class="nav-link cart-btn">üõí</a></li>
                    <!-- Login button with special styling -->
                    <li><a href="{{ url_for('login.login') }}" class="nav-link login-btn">LOGIN</a></li>
                </ul>
            </nav>
        </div>
    </header>

   <!-- Simplified Header Section -->
<section class="shop-header"></section>


    <!-- Filters Section -->
    <section class="filters-section">
        <div class="filters-container">
            <!-- üß≠ Category Filter -->
            <div class="category-filter">
            <label for="categorySelect">Filter by Category:</label>
            <select id="categorySelect" class="category-select">
                <option value="all" selected>All Categories</option>
            </select>
            </div>
            <div class="filter-group">
            <label class="filter-label" for="priceSelect">Price Range:</label>
            <select id="priceSelect" class="filter-select">
                <option value="all" selected>All Prices</option>
            </select>
            </div>
            <div class="filter-group">
            <label class="filter-label" for="sortSelect">Sort:</label>
            <select class="filter-select" id="sortSelect">
                <option value="newest">Newest First</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="popularity">Most Popular</option>
                <option value="rating">Highest Rated</option>
            </select>
            </div>

            <input type="text" class="search-box" id="searchInput" placeholder="Search products...">
        </div>
    </section>

    <!-- Products Section -->
    <section class="products-section">
    <div class="products-container">
        <div class="products-grid" id="productGrid"></div>
    </div>
    </section>

    <!-- üõí CART MODAL CONTAINER -->
    <div id="cartModal" class="cart-modal">
    <div class="cart-modal-content">
        <div id="cartContent"></div> <!-- cart.html will load here -->
    </div>
    </div>
    <!-- Back to Home Button -->
    <a href="{{ url_for('home.index') }}" class="back-to-home">‚Üê Back to Home</a>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 ATBI - Agri-Aqua Business Incubator. All rights reserved.</p>
        </div>
    </footer>

    <!-- JavaScript for product actions -->
     <script>
    // Check if user is logged in via session
    function checkLoginStatus() {
        return sessionStorage.getItem('user_id') !== null;
    }

    // Require login before any restricted action
    function requireLogin(action) {
        if (!checkLoginStatus()) {
            alert(`Please log in to ${action}.`);
            window.location.href = '/login'; // redirect to your login page
            return false;
        }
        return true;
    }

    // Add to cart
    async function addToCart(productId) {
        if (!requireLogin('add items to cart')) return;

        const quantity = 1;
        const userId = sessionStorage.getItem('user_id');

        try {
            const res = await fetch('/cart/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: productId, quantity, user_id: userId })
            });
            const data = await res.json();
            if (data.success) {
                showNotification('Added to cart!', 'success');
                updateCartCount();
            } else {
                showNotification(data.message || 'Failed to add to cart', 'error');
            }
        } catch (err) {
            console.error(err);
            showNotification('Server error. Try again later.', 'error');
        }
    }

    // Reserve product
    async function reserveProduct(productId) {
        if (!requireLogin('reserve products')) return;

        const quantity = 1;
        const userId = sessionStorage.getItem('user_id');

        try {
            const res = await fetch('/reservations/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ product_id: productId, quantity, user_id: userId })
            });
            const data = await res.json();

            if (data.success) {
                showNotification(`Product reserved! Status: ${data.status}`, 'success');
                updateReserveButton(productId, data.status);
            } else {
                showNotification(data.message || 'Reservation failed', 'error');
            }
        } catch (err) {
            console.error(err);
            showNotification('Server error. Try again later.', 'error');
        }
    }

    // Update reserve button based on status
    function updateReserveButton(productId, status) {
        const button = document.querySelector(`[data-id="${productId}"] .reserve-btn`);
        if (!button) return;

        const colors = {
            pending: 'linear-gradient(135deg, #facc15 0%, #eab308 100%)',
            approved: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
            completed: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
            rejected: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'
        };

        button.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        button.style.background = colors[status] || colors.pending;
        button.disabled = status !== 'pending'; // allow cancel only for pending if you want
    }

    // Load user's reservations and update buttons
    async function loadUserReservations() {
        const userId = sessionStorage.getItem('user_id');
        if (!userId) return;

        try {
            const res = await fetch(`/reservations/user/${userId}`);
            const data = await res.json();
            if (data.success && Array.isArray(data.reservations)) {
                data.reservations.forEach(r => updateReserveButton(r.product_id, r.status));
            }
        } catch (err) {
            console.error(err);
        }
    }

    // Add to wishlist
    function addToWishlist(productId) {
        if (!requireLogin('add items to wishlist')) return;

        const card = document.querySelector(`[data-id="${productId}"]`);
        const productName = card.querySelector('.product-title').textContent;
        const productPrice = parseFloat(card.querySelector('.product-price').textContent.replace('‚Ç±', ''));

        let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        const existingItem = wishlist.find(item => item.id === productId);

        if (!existingItem) {
            wishlist.push({
                id: productId,
                name: productName,
                price: productPrice,
                addedAt: new Date().toISOString()
            });
            localStorage.setItem('wishlist', JSON.stringify(wishlist));
            showNotification('Added to wishlist!', 'success');
            updateWishlistButton(productId, true);
        } else {
            showNotification('Already in wishlist!', 'info');
        }
    }

    // On page load
    document.addEventListener('DOMContentLoaded', () => {
        updateCartCount();
        loadUserReservations();
    });

    //Modern notification popup
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        max-width: 300px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        `;

        const colors = {
        success: 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)',
        error: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
        info: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
        default: 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)'
        };
        notification.style.background = colors[type] || colors.default;

        document.body.appendChild(notification);
        setTimeout(() => notification.style.transform = 'translateX(0)', 100);
        setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    //Update cart count in header
    function updateCartCount() {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
        const cartBtn = document.querySelector('.cart-btn');
        if (cartBtn) cartBtn.textContent = totalItems > 0 ? `üõí (${totalItems})` : 'üõí';
    }

    //Update reserve/wishlist button states
    function updateReserveButton(productId, isReserved) {
        const button = document.querySelector(`[data-id="${productId}"] .reserve-btn`);
        if (button && isReserved) {
        button.textContent = 'Reserved';
        button.style.background = 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)';
        button.disabled = true;
        }
    }

    function updateWishlistButton(productId, isInWishlist) {
        const button = document.querySelector(`[data-id="${productId}"] .wishlist-btn`);
        if (button && isInWishlist) {
        button.textContent = '‚ô•';
        button.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        }
    }

    //On page load
    document.addEventListener('DOMContentLoaded', () => {
        const reservations = JSON.parse(localStorage.getItem('reservations') || '[]');
        reservations.forEach(r => {
        if (new Date(r.expiresAt) > new Date()) updateReserveButton(r.id, true);
        });

        const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
        wishlist.forEach(w => updateWishlistButton(w.id, true));

        updateCartCount();
    });
    </script>
    <script src="{{ url_for('static', filename='js/cart.js') }}"></script>
    <script>
    document.addEventListener("DOMContentLoaded", async () => {
        const searchBox = document.querySelector(".search-box");
        const categorySelect = document.getElementById("categorySelect");
        const priceSelect = document.getElementById("priceSelect");
        const sortSelect = document.getElementById("sortSelect");
        const productGrid = document.getElementById("productGrid");

        let products = [];

        try {
            // Fetch products from backend
            const response = await fetch("/admin/get-products");
            const data = await response.json();
            if (!data.success) throw new Error("Failed to fetch products");

            products = data.products;

            /* Populate Category Dropdown */
            const categories = [...new Set(products.map(p => p.category).filter(Boolean))];
            categorySelect.innerHTML = `<option value="all" selected>All Categories</option>`;
            categories.forEach(cat => {
                const option = document.createElement("option");
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });

            /* Generate Dynamic Price Ranges */
            const prices = products.map(p => parseFloat(p.price_per_stocks)).filter(p => !isNaN(p));
            const minPrice = Math.floor(Math.min(...prices));
            const maxPrice = Math.ceil(Math.max(...prices));
            const range = maxPrice - minPrice;

            let numRanges = 3;
            if (range > 1000 && range <= 3000) numRanges = 4;
            else if (range > 3000) numRanges = 5;

            const step = Math.ceil(range / numRanges);
            const priceRanges = [];

            for (let i = 0; i < numRanges; i++) {
                const start = minPrice + i * step;
                const end = i === numRanges - 1 ? maxPrice : start + step;
                priceRanges.push({ start, end });
            }

            priceSelect.innerHTML = `<option value="all" selected>All Prices</option>`;
            priceRanges.forEach(r => {
                const option = document.createElement("option");
                option.value = `${r.start}-${r.end}`;
                option.textContent = `‚Ç±${r.start.toLocaleString()} - ‚Ç±${r.end.toLocaleString()}`;
                priceSelect.appendChild(option);
            });

            if (range > 5000) {
                const lastOption = document.createElement("option");
                lastOption.value = `${maxPrice}+`;
                lastOption.textContent = `‚Ç±${maxPrice.toLocaleString()}+`;
                priceSelect.appendChild(lastOption);
            }

            /*Initial render */
            renderProducts(products);

            /* Event listeners */
            categorySelect.addEventListener("change", () => applyFiltersAndSorting(products));
            priceSelect.addEventListener("change", () => applyFiltersAndSorting(products));
            sortSelect.addEventListener("change", () => applyFiltersAndSorting(products));

            /* Debounced Search with fuzzy matching */
            let searchTimeout;
            searchBox.addEventListener("input", () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => performSearch(searchBox.value.trim().toLowerCase()), 300);
            });

        } catch (err) {
            console.error("Error loading products:", err);
            productGrid.innerHTML = `<p style="color:red;">Error loading products.</p>`;
        }

        /* Search Function with fuzzy support */
        function performSearch(query) {
            if (!query) {
                applyFiltersAndSorting(products);
                return;
            }

            const filtered = products.filter(p => {
                const fields = [p.name, p.products, p.category, p.details]
                    .filter(Boolean)
                    .map(str => str.toLowerCase());

                return fields.some(field =>
                    field.includes(query) || getSimilarity(field, query) >= 0.7
                );
            });

            applyFiltersAndSorting(filtered);
        }

        /* Fuzzy match helpers */
        function getSimilarity(a, b) {
            const distance = levenshteinDistance(a, b);
            return 1 - distance / Math.max(a.length, b.length);
        }

        function levenshteinDistance(a, b) {
            const dp = Array.from({ length: a.length + 1 }, () => Array(b.length + 1).fill(0));
            for (let i = 0; i <= a.length; i++) dp[i][0] = i;
            for (let j = 0; j <= b.length; j++) dp[0][j] = j;
            for (let i = 1; i <= a.length; i++) {
                for (let j = 1; j <= b.length; j++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    dp[i][j] = Math.min(
                        dp[i - 1][j] + 1,
                        dp[i][j - 1] + 1,
                        dp[i - 1][j - 1] + cost
                    );
                }
            }
            return dp[a.length][b.length];
        }

        /* Filter + Sort combo */
        function applyFiltersAndSorting(list) {
            const selectedCategory = categorySelect.value;
            const selectedPrice = priceSelect.value;
            const selectedSort = sortSelect.value;

            let filtered = [...list];

            // Category filter
            if (selectedCategory !== "all") {
                filtered = filtered.filter(p => p.category === selectedCategory);
            }

            // Price filter
            if (selectedPrice !== "all") {
                if (selectedPrice.includes("+")) {
                    const min = parseFloat(selectedPrice.replace("+", ""));
                    filtered = filtered.filter(p => p.price_per_stocks >= min);
                } else {
                    const [min, max] = selectedPrice.split("-").map(Number);
                    filtered = filtered.filter(p => p.price_per_stocks >= min && p.price_per_stocks <= max);
                }
            }

            // Sorting
            switch (selectedSort) {
                case "newest":
                    filtered.sort((a, b) => new Date(b.added_on) - new Date(a.added_on));
                    break;
                case "price-low":
                    filtered.sort((a, b) => a.price_per_stocks - b.price_per_stocks);
                    break;
                case "price-high":
                    filtered.sort((a, b) => b.price_per_stocks - a.price_per_stocks);
                    break;
            }

            smoothTransition(() => renderProducts(filtered));
        }

        /*Smooth fade transition */
        function smoothTransition(callback) {
            productGrid.style.opacity = "0";
            setTimeout(() => {
                callback();
                productGrid.style.opacity = "1";
            }, 200);
        }

        /*Product rendering */
        function renderProducts(products) {
            if (!products.length) {
                productGrid.innerHTML = `<p style="text-align:center;color:#999;">No matching products found.</p>`;
                return;
            }

            productGrid.innerHTML = products.map(p => {
                const imgSrc = p.image_path
                    ? `/${p.image_path}`
                    : "{{ url_for('static', filename='images/no-image.png') }}";

                let extraInfo = "";
                if (p.expiration_date && p.expiration_date !== "No Expiry") {
                    extraInfo = `<div class="product-expiry">Expiration: ${p.expiration_date}</div>`;
                } else if (p.warranty) {
                    extraInfo = `<div class="product-expiry">Warranty: ${p.warranty}</div>`;
                } else {
                    extraInfo = `<div class="product-expiry">Warranty: None</div>`;
                }

                return `
                    <div class="product-card" data-id="${p.incubatee_id}">
                        <div class="product-image">
                            <img src="${imgSrc}" alt="${p.name}">
                        </div>
                        <div class="product-info">
                            <div class="product-category">${p.category || "Uncategorized"}</div>
                            <h3 class="product-title">${p.name}</h3>
                            <p class="product-description">${p.details}</p>
                            <div class="product-details">
                                <div class="product-price">‚Ç±${parseFloat(p.price_per_stocks).toLocaleString(undefined, { minimumFractionDigits: 2 })}</div>
                                ${extraInfo}
                            </div>
                            <div class="product-actions">
                                <button class="add-to-cart" onclick="addToCart(${p.incubatee_id})">Add to Cart</button>
                                <button class="reserve-btn" onclick="reserveProduct(${p.incubatee_id})">Reserve</button>
                                <button class="wishlist-btn" onclick="addToWishlist(${p.incubatee_id})">‚ô•</button>
                            </div>
                        </div>
                    </div>`;
            }).join("");
        }
    });
    </script>
</body>
</html>
